<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BLE Keyboard Remote</title>
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            margin: 0;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .status {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .status.disconnected { background: #e74c3c33; color: #e74c3c; }
        .status.connecting { background: #f39c1233; color: #f39c12; }
        .status.connected { background: #27ae6033; color: #27ae60; }

        #connectBtn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            background: #3498db;
            color: white;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 600;
        }

        #connectBtn:active { background: #2980b9; }
        #connectBtn:disabled { background: #555; cursor: not-allowed; }

        .input-section {
            margin-bottom: 20px;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        #textInput {
            flex: 1;
            padding: 14px;
            font-size: 1rem;
            border: 2px solid #3498db;
            border-radius: 12px;
            background: #0f0f23;
            color: #eee;
            outline: none;
        }

        #sendBtn {
            padding: 14px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 12px;
            background: #27ae60;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        #sendBtn:active { background: #1e8449; }

        .section-title {
            font-size: 0.85rem;
            color: #888;
            margin: 16px 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .key-grid {
            display: grid;
            gap: 8px;
        }

        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        .key-btn {
            padding: 16px 8px;
            font-size: 0.9rem;
            border: none;
            border-radius: 10px;
            background: #2c3e50;
            color: #eee;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.1s;
        }

        .key-btn:active {
            background: #34495e;
            transform: scale(0.95);
        }

        .key-btn.wide { grid-column: span 2; }
        .key-btn.primary { background: #3498db; }
        .key-btn.danger { background: #c0392b; }
        .key-btn.success { background: #27ae60; }

        .modifier-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .mod-btn {
            padding: 14px 8px;
            font-size: 0.85rem;
            border: 2px solid #555;
            border-radius: 10px;
            background: #1a1a2e;
            color: #888;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.15s;
        }

        .mod-btn.active {
            border-color: #e74c3c;
            background: #e74c3c33;
            color: #e74c3c;
            box-shadow: 0 0 10px #e74c3c55;
        }

        .arrows {
            display: grid;
            grid-template-areas:
                ". up ."
                "left down right";
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
        }

        .arrows .key-btn[data-key="!UP"] { grid-area: up; }
        .arrows .key-btn[data-key="!DOWN"] { grid-area: down; }
        .arrows .key-btn[data-key="!LEFT"] { grid-area: left; }
        .arrows .key-btn[data-key="!RIGHT"] { grid-area: right; }

        .hidden { display: none; }

        .log {
            margin-top: 20px;
            padding: 12px;
            background: #0f0f23;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 120px;
            overflow-y: auto;
            color: #888;
        }

        .log-entry { margin: 4px 0; }
        .log-entry.sent { color: #27ae60; }
        .log-entry.error { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BLE Keyboard</h1>

        <div id="status" class="status disconnected">Disconnected</div>

        <button id="connectBtn">Connect to AtomS3U</button>

        <div id="controls" class="hidden">
            <div class="input-section">
                <div class="input-row">
                    <input type="text" id="textInput" placeholder="Type text to send...">
                    <button id="sendBtn">Send</button>
                </div>
            </div>

            <div class="section-title">Modifiers (tap to lock, tap again or type to release)</div>
            <div class="modifier-row">
                <button class="mod-btn" data-mod="CTRL" data-cmd="!HOLD+CTRL">Ctrl</button>
                <button class="mod-btn" data-mod="ALT" data-cmd="!HOLD+ALT">Alt</button>
                <button class="mod-btn" data-mod="SHIFT" data-cmd="!HOLD+SHIFT">Shift</button>
                <button class="mod-btn" data-mod="SUPER" data-cmd="!HOLD+SUPER">Super</button>
            </div>

            <div class="section-title">Common Keys</div>
            <div class="key-grid grid-4">
                <button class="key-btn primary wide" data-key="!ENTER">Enter</button>
                <button class="key-btn" data-key="!TAB">Tab</button>
                <button class="key-btn" data-key="!ESC">Esc</button>
                <button class="key-btn" data-key="!BACKSPACE">Bksp</button>
                <button class="key-btn" data-key=" ">Space</button>
                <button class="key-btn" data-key="!F5">F5</button>
                <button class="key-btn danger" data-key="!RELEASE">Release</button>
            </div>

            <div class="section-title">Arrows</div>
            <div class="arrows">
                <button class="key-btn" data-key="!UP">&#9650;</button>
                <button class="key-btn" data-key="!LEFT">&#9664;</button>
                <button class="key-btn" data-key="!DOWN">&#9660;</button>
                <button class="key-btn" data-key="!RIGHT">&#9654;</button>
            </div>

            <div class="section-title">Shortcuts</div>
            <div class="key-grid grid-4">
                <button class="key-btn" data-key="!CTRL+A">Ctrl+A</button>
                <button class="key-btn" data-key="!CTRL+C">Ctrl+C</button>
                <button class="key-btn" data-key="!CTRL+V">Ctrl+V</button>
                <button class="key-btn" data-key="!CTRL+Z">Ctrl+Z</button>
                <button class="key-btn" data-key="!CTRL+T">Ctrl+T</button>
                <button class="key-btn" data-key="!CTRL+W">Ctrl+W</button>
                <button class="key-btn" data-key="!CTRL+S">Ctrl+S</button>
                <button class="key-btn" data-key="!ALT+TAB">Alt+Tab</button>
            </div>

            <div class="section-title">Function Keys</div>
            <div class="key-grid grid-4">
                <button class="key-btn" data-key="!F1">F1</button>
                <button class="key-btn" data-key="!F2">F2</button>
                <button class="key-btn" data-key="!F3">F3</button>
                <button class="key-btn" data-key="!F4">F4</button>
                <button class="key-btn" data-key="!F6">F6</button>
                <button class="key-btn" data-key="!F7">F7</button>
                <button class="key-btn" data-key="!F8">F8</button>
                <button class="key-btn" data-key="!F9">F9</button>
                <button class="key-btn" data-key="!F10">F10</button>
                <button class="key-btn" data-key="!F11">F11</button>
                <button class="key-btn" data-key="!F12">F12</button>
            </div>
        </div>

        <div id="log" class="log"></div>
    </div>

    <script>
        // Nordic UART Service UUIDs
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const CHAR_RX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

        let device = null;
        let characteristic = null;
        const activeModifiers = new Set();

        const connectBtn = document.getElementById('connectBtn');
        const controls = document.getElementById('controls');
        const status = document.getElementById('status');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const log = document.getElementById('log');

        function setStatus(state, text) {
            status.className = 'status ' + state;
            status.textContent = text;
        }

        function addLog(msg, type = '') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
            log.insertBefore(entry, log.firstChild);
            if (log.children.length > 50) log.removeChild(log.lastChild);
        }

        async function connect() {
            try {
                setStatus('connecting', 'Scanning...');
                addLog('Scanning for devices...');

                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }],
                    optionalServices: [SERVICE_UUID]
                });

                setStatus('connecting', 'Connecting...');
                addLog('Connecting to ' + device.name);

                device.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_RX_UUID);

                setStatus('connected', 'Connected: ' + device.name);
                addLog('Connected!', 'sent');
                controls.classList.remove('hidden');
                connectBtn.textContent = 'Disconnect';

            } catch (error) {
                console.error(error);
                setStatus('disconnected', 'Connection failed');
                addLog('Error: ' + error.message, 'error');
            }
        }

        function onDisconnected() {
            setStatus('disconnected', 'Disconnected');
            addLog('Device disconnected', 'error');
            controls.classList.add('hidden');
            connectBtn.textContent = 'Connect to AtomS3U';
            characteristic = null;
        }

        async function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }

        async function send(text) {
            if (!characteristic) {
                addLog('Not connected!', 'error');
                return;
            }

            try {
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(text));
                addLog('Sent: ' + text, 'sent');
            } catch (error) {
                addLog('Send error: ' + error.message, 'error');
            }
        }

        connectBtn.addEventListener('click', () => {
            if (device && device.gatt.connected) {
                disconnect();
            } else {
                connect();
            }
        });

        sendBtn.addEventListener('click', async () => {
            if (textInput.value) {
                await send(textInput.value);
                textInput.value = '';
                if (activeModifiers.size > 0) {
                    await send('!RELEASE');
                    clearModifiers();
                }
            }
        });

        textInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && textInput.value) {
                await send(textInput.value);
                textInput.value = '';
                if (activeModifiers.size > 0) {
                    await send('!RELEASE');
                    clearModifiers();
                }
            }
        });

        function clearModifiers() {
            activeModifiers.clear();
            document.querySelectorAll('.mod-btn').forEach(b => b.classList.remove('active'));
        }

        // Modifier toggle buttons
        document.querySelectorAll('.mod-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const mod = btn.dataset.mod;
                const cmd = btn.dataset.cmd;

                if (activeModifiers.has(mod)) {
                    // Already active - release all and clear
                    await send('!RELEASE');
                    clearModifiers();
                } else {
                    // Activate this modifier
                    await send(cmd);
                    activeModifiers.add(mod);
                    btn.classList.add('active');
                }
            });
        });

        // Regular key buttons - release modifiers after key press
        document.querySelectorAll('.key-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const key = btn.dataset.key;
                if (key) {
                    await send(key);
                    // Release modifiers after any key press (except !RELEASE itself)
                    if (key !== '!RELEASE' && activeModifiers.size > 0) {
                        await send('!RELEASE');
                        clearModifiers();
                    } else if (key === '!RELEASE') {
                        clearModifiers();
                    }
                }
            });
        });

        // Check for Web Bluetooth support
        if (!navigator.bluetooth) {
            setStatus('disconnected', 'Web Bluetooth not supported');
            connectBtn.disabled = true;
            addLog('Web Bluetooth requires Chrome on Android or Desktop', 'error');
        }
    </script>
</body>
</html>
